%\documentclass[letter,10pt,final]{article}
\documentclass[letter,10pt]{article}
\usepackage[utf8]{inputenc}
\usepackage{graphicx}
\usepackage{xcolor}
\definecolor{criticalColor}{HTML}{FF3333}
\definecolor{refinementColor}{HTML}{B3FFCC}
\definecolor{infoColor}{HTML}{FFFF80}
\usepackage[obeyFinal,color=criticalColor,figwidth=.8\textwidth]{
todonotes}
\usepackage{hyperref}
\hypersetup{
    colorlinks,
    linkcolor={red!50!black},
    citecolor={blue!50!black},
    urlcolor={blue!80!black}
} %TODO: Check colors
\usepackage{nameref}

%http://tex.stackexchange.com/questions/60209/how-to-add-an-extra-level-
%of-sections-with-headings-below-subsubsection
\makeatletter
\renewcommand\paragraph{\@startsection{paragraph}{4}{\z@}%
            {-2.5ex\@plus -1ex \@minus -.25ex}%
            {1.25ex \@plus .25ex}%
            {\normalfont\normalsize\bfseries}}
\makeatother
\setcounter{secnumdepth}{4} % how many sectioning levels to assign 
%numbers to
\setcounter{tocdepth}{4}    % how many sectioning levels to show in ToC

%opening
\title{Automating Code Magnet Generation}
\author{Julia Dana}
\date{}

\begin{document}

\maketitle

%\begin{abstract}
%\end{abstract}

\clearpage
\tableofcontents

\clearpage
\listoftodos

\clearpage

\section{Introduction} 
\todo[color=infoColor]{Defense of the problem definition}

\subsection{The Overview: Easier Creation of Code Magnet Microlabs}

The purpose of this project is to assist in the creation of code magnet 
microlab assignments for WAGS by creating magnets from a completed 
solution file. This is accomplished in a manner that supports multiple 
programming languages, and allows additional languages to be added with 
minimal configuration. Additional tools that support this idea of 
easier creation of assignments are also included, such as an automated
interaction with the WAGS website to create assignments. Also, this 
project defines new formats for representing magnets, both as
objects, and serialized to JSON or YAML. 

\subsection{The Context: What is WAGS?}

WAGS (Web Automated Grading System) is an ongoing project of 
Appalachian State University. It is an online tool for microlabs. 
Microlabs are short, 5-10 minutes hands-on activities that are 
intended to be done as a part of a regular (i.e. not lab) class session 
to reinforce the concepts that are currently being covered. There 
are multiple types of microlabs provided by WAGS, but the one that 
this project is interested in is code magnet microlabs. These are 
microlabs where the student is given code magnets (pieces of code). 
Then the student must choose the correct magnets to use and drag 
and drop them into the correct order to “write” a solution to the 
microlab.

\missingfigure{Add figure of in progress magnet microlab}
%\begin{figure}
% \centering
% \includegraphics[width=3in]{./images/missing-image.png}
% \caption{An in-progress magnet microlab}
% \label{fig:magnets}
% %\todo{Add figure of in progress magnet microlab}
% %\todo{Make sure picture is in a good location in the text}
%\end{figure}

\subsection{The Problem: Brittle Input}

The problem is that creating these magnet microlab assignments on the 
WAGS website is a somewhat painful process. The current parser creates 
a magnet per line, and this can result in having to format the input 
file so that is no longer the same as a solution file, and is indeed no 
longer valid for its language.

\missingfigure{Parser example}

If your input cannot be handled by this brittle parser. WAGS does 
provide a manual input for magnets. However, using this manual input 
requires magnets to either be entered one at a time to the magnet 
creation wizard, or for the user to directly type the final magnet 
(including HTML escape sequences) to the parsed output section. 

\missingfigure{magnet assignment creation page}

\subsection{The Solution: Parsing by Grammar}

The solution to this is to use a more robust parser that is based on 
the grammar of a language, rather than simply splitting on line breaks. 
This project does this by using the ANTLR4 parser 
generator\cite{antlr-reference} and freely available grammars for 
common languages\cite{antlr-grammars-project}.

Roughly speaking, using a grammar-based parser to break code into 
magnets is like breaking apart a paragraph based on sentences or 
phrases, rather than on every period (Which commonly indicates the end 
of a sentence, but also has other uses, such as abbreviations). This 
type of parser will create tokens from the input, which are loosely the 
equivalent of words, and then break them into (sometimes nested) 
phrases and sentences according to rules called productions. Rules are 
named, and will sometimes contain more than one production as 
alternatives that provide the same function in a language.

One of the outputs available from a parser is a parse tree. This is 
similar to a sentence diagram.

However, writing a robust parser is a non-trivial task. Today, most 
parsers are created by parser generators. These take the description of 
the language given in a grammar, and creates the parser for that 
language. There are many such parser generators, including \todo{list 
and cite parser generators}. This project uses ANTLR4, which generates 
parsers in Java. \todo[color=refinementColor]{expand on ANTLR - 
LL(star)} 

\section{Development results and future extensions}
\todo[color=infoColor]{Defense of solution}

\subsection{What It Does: Internal Functions}

\subsubsection{Parses by Grammar}

\todo{Clarify this entire section}
The magnetizer \todo{magnetizer find a better word} takes an input 
file, and parses it with the parser generated by ANTLR from the grammar 
specification. The result of this parsing is a parse tree, which can 
be represented graphically. An example follows.

For this simple Java file, Hello.java
\missingfigure{Listing: Hello.java}

The resulting parse tree is:

\missingfigure{Show a simple parse tree}
\label{fig:parseTree}

Each language supported by the magnetizer has an entry in a 
configuration file that specifies which nodes in the parse tree should 
trigger the creation of a magnet. Whenever a child node triggers its 
own magnet, the parent is given a drop zone for that section, and that 
section of text is not directly included in the parent magnet.


\todo{ANTLR visitor vs. listener}


\subsubsection{Alternative Magnets and Other Instructor Directives}

Instructor directives allow instructors to control how magnets are 
created. They are implemented as special comments. The 
content of directives are the same across all languages, but the 
triggering comment syntax is specific to each input language. Current 
directives implemented all instructors to suppress drop zones, or to 
indicate that a duplicate magnet with a section of alternate text 
should be created.

\subsubsection{Improved Representation of Magnets}

The old format for describing magnets is difficult to read and worse to 
try to manually type. Some of its quirks are that magnets are separated 
by an unusual separator (\verb~.:|:.~), areas that accept other magnets 
(aka drop zones) are indicated by a seemingly random set of HTML tags 
(\verb~<br><!-- panel --><br>~), and any special characters used in the 
code magnet must be escaped for HTML (so something like \verb~1 < 2~ 
would need to be entered as \verb~1 &lt; 2~). This format also is 
limited when trying to create more advanced types of magnets. The WAGS 
system addresses this problem by adding more form fields when adding 
``advanced Java magnets'', but this does not work well for adding 
additional languages.

\missingfigure{Creating a magnet assignment with advanced magnets}

This project creates an underlying object based data structure for 
magnets, as shown in figure \todo{link figure of class diagram}. This 
structure can then be serialized as desired. Currently, serialization to 
the old magnet format is supported for backward compatibility, as well 
as JSON and YAML for more robust usages.

\missingfigure{Class diagram of Magnets}


\subsection{What It Does: External Functions}

\subsubsection{Command Line Tool}

This project provides a command line tool, which is a thin wrapper 
exposing the internal API functions to the command line.

%\subsubsection{GUI Tool}

\subsubsection{Automated Interaction With WAGS Website}


\subsection{What It Could Do: Future Extensions}

\subsubsection{Automatic Generation of Alternative/Distractor Magnets}

The next step in easily creating code magnet assignments is to have the 
magnet creation tool not simply create magnets needed for the correct 
solution and any additional magnets specified by the instructor, but 
also to automatically create appropriate alternative ``distractor'' 
magnets for common student misconceptions and errors. This level of 
manipulation is available because we have the whole parse tree to work 
with during magnet creation, but would require significant work per 
language to define.

\subsubsection{GUI Tool}

A GUI tool that can open an input file, perform the actions of the CLI 
tool on it, and also has an editor to assist in the addition of any 
instructor directives desired would be a nice addition to this project.

\subsubsection{Supporting New Languages}

This project currently can create magnets for Python3 and Java, however 
it is set up to easily allow the addition of new languages. 
Basically, this is done by finding and adding an ANTLR4 grammar file 
for the desired language, making sure it conforms to a handful of 
guidelines, writing a short configuration file, and running a setup 
action on the project. Full details of this process are in 
section~\ref{sec:newLang} \nameref{sec:newLang}.


\subsubsection{Additional Serialization Formats}

Because magnets are now objects, additional serialization formats (such 
as XML) could easily be added. 



\section{User Guide}
\todo[color=infoColor]{Targeted to a CIS 1 instructor}

\subsection{Quick Start - CLI Tool}

The primary interface to this project is the magnetizer command line 
tool. This tool is capable of outputing to WAGS-style magnets that can 
be copy-pasted into the parsed sections of the WAGS website or to a 
JSON or YAML representation of the magnets.

\todo{Make sure usage is the latest version.}
\begin{verbatim}
Usage: magnetizer [options] file
    -l, --language LANGUAGE          Specify a language (default: Java)
        --json                       Print the JSON output
        --yaml                       Print the YAML output
        --[no-]wags                  Print the output as WAGS magnets 
(default)
    -o, --output-file BASE_FILENAME  Output to a file
    -h, --help                       Show this message
\end{verbatim}


%\subsection{Quick Start - GUI Tool (tent.)}

\subsection{Installation for Use}

% An overview of how a file is split into magnets.
\subsection{Explanation of Output}

\todo{explain these in a way that doesn't require 
deep understanding of the ANTLR grammar.}

\subsubsection{Java}
The current configuration for Java creates magnets for
\begin{itemize}
 \item Package declarations
 \item Import declarations
 \item Type declarations
 \item Class body declarations - this is the nonterminal that includes 
anything that can be directly in the class body
 \item Block statements - this is the nonterminal that includes 
anything that can be directly inside a block.
\end{itemize}

\subsubsection{Python 3}
The current configuration for Python creates magnets for
\begin{itemize}
 \item simple statements
 \item compound statements
\end{itemize}


\subsection{Modifying the Output: Instructor Directives}
Instructor directives are information that can be put in the input file 
that change how the magnets are created. They are a special version of 
comments. The triggering syntax varies per language, but the directives 
are the same for all languages.

\begin{description}
 \item [Java] \verb~ /*# <directive> */~
 \item [Python3] \verb~ ## <directive>~
\end{description}



Note that directives in python are somewhat limited because comments 
cannot occur in a line. \todo{Verify that there are no inline comments 
in python}

\subsubsection{ALT and ENDALT: Creating Alternative Magnets}

The ALT and ENDALT directives are used to create alternatives with 
different text for a magnet. The ALT directive also takes the desired 
alternative text, and the ENDALT directive is used to indicate where 
the end of the alternative text is. These directives should always be 
used as a pair, and encompass the text that should be replaced. They 
cannot go around anything that would trigger the creation of a new 
magnet or drop zone.draft

\todo{Concrete example of ALT}

\subsubsection{NODROP: Suppressing Drop Zones}

The NODROP directive suppresses the creation of drop zones for the 
following magnet. An example of when this would be used is to put an 
entire loop on a single magnet, rather than having the individual 
statements in the body be on their own magnets.

\todo{Concrete example of NODROP}


\subsection{Automatic Upload to WAGS Website}

\section{Developer Notes}
\todo[color=infoColor]{Targeted to someone expanding on this project}

\subsection{The Environment: Languages and Libraries Used}

\todo{Section needs more details}

This project is written to run on JRuby. The magnetizer itself is 
written in Ruby, but it uses the Java classes provided by ANTLR. JRuby 
allows this to occur.

Automated interaction with the WAGS site is provided by using Capybara 
to interact with Selenium (drives Firefox) or Poltergeist/PhantomJS 
(headless).

Rake (Ruby make) is used to process new grammar files and other build 
tool functionality.

RSpec is used to handle testing

\subsubsection{Installation for Development}
\todo{Consider if this section should be on its own}

\subsection{The Testing}

\subsection{The Design}

\subsection{The Configuration: Specifying Magnet Sections}

\subsection{The Expansion: Adding a New Language}
\label{sec:newLang}

\subsubsection{New Grammar Specification}
A new G4 file can be added to the system. However, whitespace is
require to go on channel 1, or your magnets will not have any
whitespace, and you might get things like ``publicclassMyClass''.

%\clearpage
%\section{Glossary}
%\todo{Write the glossary}
%\begin{description}
% \item [magnet] What a magnet is.
%\end{description}


\clearpage
\todo{Final export of bibliography from Mendeley and link it}
\todo{Make sure citations and bibliography are styled correctly}
\addcontentsline{toc}{section}{References}
\bibliography{bibliography}{}
\bibliographystyle{plain}

\end{document}
